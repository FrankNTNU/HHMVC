
@{
    ViewBag.Title = "Login";
    Layout = "~/Views/Shared/HomeLayout2.cshtml";
}
@section Styles {
    <link href="~/Content/toastr/toastr.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
}
@model DTO.UserDTO
<header style="background-color: #fff0f0; width: 100%; padding-right: 0px " class="pt-5 pb-1 m-0 col-12">
    <div class="row" style="width: 100%; padding-right: 20px">

        <div class="col-4 col-sm-4 col-lg-2 p-2 p-0" style="text-align:center">
            <a href="/Home2/Index"><img src="~/Areas/Admin/Content/tempimage/hLogoRed.jpg" style="max-width:90px;width:100%"></a>
        </div>
        <div class="col-6 col-sm-6 col-lg-8 p-1 align-self-center">
            <h2><i class="far fa-user"> </i> 會員登入</h2>
        </div>
        <div class="col-2 col-md-2 align-self-end justify-content-end d-flex">


        </div>
    </div>
</header><header id="header" class="m-0 p-0"></header>


@Html.Partial("~/Areas/Admin/Views/Shared/MessageForm.cshtml")

<div>

    <p style="color:red">需註冊後才可使用Google登入</p><button type="button" id="btnSignIn" class="button default m-0">Google登入</button>
    <!--用戶解除Google帳戶綁定時使用↓-->
    @*<button type="button" id="btnDisconnect">斷連Google App</button>*@
</div>

<form action="@Url.Action("Login")" method="post">

    <div class="row">
        <div class="col-12">
            @Html.ValidationMessageFor(x => x.Email, "", new { @style = "color:red" })
            <br /><label>帳號(Email)</label>

            <input type="text" name="Email" id="demo-email" value="" placeholder="登入帳號" style="height:50px" autocomplete="off" />
        </div>
        <div class="col-12">
            @Html.ValidationMessageFor(x => x.Password, "", new { @style = "color:red" })
            <br /><label>密碼</label>

            <input type="password" name="Password" id="demo-pwd" value="" placeholder="你的密碼" style="height:50px" />
            <button type="button" id="btnNewPwd" class="button default m-0">忘記密碼</button>
        </div>
        <div class="row">
            <div class="col-3">
                <label>輸入右側驗證碼：</label>
            </div>
            <div class="col-5">
                <input type="text" name="code" />
            </div>
            <div class="col-3">
                <img id="code" src="/Home2/GetValidateCode/" />
            </div>
        </div>
        <!-- Break -->
        <!-- Break -->
        <div class="col-12" style="margin-top:10px">
            <ul class="actions">
                <li style="font-size:1.1em"><input type="submit" value="登入" class="primary" /></li>
                <li style="font-size:1.1em"><a class="button default m-0" href=" ~/Member/CreateMember">註冊新會員</a></li>
            </ul>
        </div>
        @if (ViewBag.ReturnUrl != null)
        {
            <input type="hidden" name="ReturnUrl" value="@ViewBag.ReturnUrl" />
        }
    </div>
</form>
@section Scripts{
    <script src="~/Content/toastr/toastr.min.js"></script>
    <!-- 引用jQuery-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <!--從 Web.config檔 抓取Googl App Client ID-->
    <script type="text/javascript">
        let GoolgeApp_Cient_Id = "210856283403-257sicfc1u5afrca31mtevcc975u1dk5.apps.googleusercontent.com";
        let id_token_to_userIDUrl = "@Url.Action("GoogleLogin","Home2")";
    </script>
    <!--引用Google Sign-in必須的.js，callback function(GoogleSigninInit)名稱自訂 -->
    <script src="https://apis.google.com/js/platform.js?onload=GoogleSigninInit" async defer></script>

    <!--以下請放置到*.js檔-->
    <script type="text/javascript">
        //jQuery處理button click event 當畫面DOM都載入時....
        $(function () {
            $("#btnSignIn").on("click", function () {
                GoogleLogin();//Google 登入
            });
            $("#btnDisconnect").on("click", function () {
                Google_disconnect();//和Google App斷連
            });

        });

        function GoogleSigninInit() {
            gapi.load('auth2', function () {
                gapi.auth2.init({
                    client_id: GoolgeApp_Cient_Id//必填，記得開發時期要開啟 Chrome開發人員工具 查看有沒有403錯誤(Javascript來源被禁止)
                });
                console.log(GoolgeApp_Cient_Id)
            });//end gapi.load
        }//end GoogleSigninInit function


        function GoogleLogin() {
            let auth2 = gapi.auth2.getAuthInstance();//取得GoogleAuth物件
            auth2.signIn().then(function (GoogleUser) {
                console.log("Google登入成功");
                console.log(GoogleUser["dt"]["Nt"]);//抓email
                let user_id = GoogleUser.getId();//取得user id，不過要發送至Server端的話，請使用↓id_token
                let AuthResponse = GoogleUser.getAuthResponse(true);//true會回傳access token ，false則不會，自行決定。如果只需要Google登入功能應該不會使用到access token
                let id_token = AuthResponse.id_token;//取得id_token
                let Email = GoogleUser["dt"]["Nt"];
                let GoogleID = user_id;
                console.log(user_id);
                AddGoogleID(Email, GoogleID);
                $.ajax({
                    url: id_token_to_userIDUrl,
                    method: "post",
                    data: { id_token: id_token },
                    success: function () {
                        window.location.href = "https://localhost:44327/Home2/Index";
                    }
                });//end $.ajax
            },
                function (error) {
                    console.log("Google登入失敗");
                    console.log(error);
                });

        }//end function GoogleLogin

        function AddGoogleID(Email, GoogleID) {
            $.ajax({
                url: "AddGoogleID",
                data: {
                    email: Email,
                    googleID: GoogleID
                }//前面事動作裡的參數，後面是這邊的參數
            })
        }

        function GetNewPassword(Email) {
            $.ajax({
                url: "GetNewPassword",
                data: {
                    email: Email
                }
                ,
                success: function () {
                    window.alert("新密碼已寄至帳號信箱")
                }
            })
        }
        $("#btnNewPwd").on("click", function () {
            let Email = $("#demo-email").val();
            GetNewPassword(Email)
        })


        function Google_disconnect() {
            let auth2 = gapi.auth2.getAuthInstance(); //取得GoogleAuth物件

            auth2.disconnect().then(function () {
                console.log('User disconnect.');
            });
        }
    </script>
}
