
@{
    ViewBag.Title = "GiftCart";
    Layout = "~/Views/Shared/HomeLayout2.cshtml";
}

@section Styles {
    <link href="~/Content/toastr/toastr.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
        @@font-face {
            font-family: 'BarcodeFont';
            src: url('../Areas/Admin/Content/webfonts/BarcodeFont.ttf')
        }

        tbody td {
            padding: 5px;
        }

        .barcodeFont {
            font-family: 'BarcodeFont';
            font-size: 3em;
            padding: 0px;
            padding-left: 10px
        }

        .centered {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: black;
        }
    </style>

}
@model List<DTO.GiftCartDTO>

<section>
    <header class="row">
        <div class="row col-12">
            <div class="col-8 col-sm-9 col-md-10" style="display:inline;">
                <h3 style="margin-bottom: 10px;">
                    <i class="fas fa-shopping-cart"></i> @Session["Name"] 的已兌換禮物
                </h3>
            </div>
            <div class="col-2 col-md-2" style="padding-right:0px; text-align:end">
                <a href="~/FrontGift/GiftList"><label class="button primary">返回商店</label></a>
            </div>
        </div>


    </header>
    <header class="major"><p class="col-12" style="margin-bottom:5px"></p></header>
    <div class="row" style="margin-bottom:5px">
        <div class="col-12 col-md-6 mb-1">
            <input type="text" id="searchText" class="form-control" placeholder="關鍵字" style="height:40px" />
        </div>
        <div class="col-12 col-md-6 mb-1">
            <select id="searchFilter" class="form-control">
                <option selected disabled value="-1">排序條件</option>
                <option value=0>截止日: 近 => 遠</option>
                <option value=1>截止日: 遠 => 低</option>
            </select>
        </div>
    </div>
    <div class="row" id="cartList">
        @foreach (var item in Model)
        {
            <div class="col-12 col-sm-4 col-md-4 d-flex justify-content-center" style="margin:auto;">
                @if (item.EndDate < DateTime.Today)
                {
                    <img class="image" src="~/Areas/Admin/Content/CartImages/@item.Image" style="max-width:200px;width:100%;opacity:0.45" />
                    <div class="centered"><h5>已截止</h5></div>
                }
                else
                {
                    <img class="image" src="~/Areas/Admin/Content/CartImages/@item.Image" style="max-width:200px;width:100%" />
                }

            </div>
            <div class="col-12 col-sm-8 col-md-8">
                <div>
                    <table style="margin-bottom:0px">
                        <thead>
                            <tr>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>名稱</strong></td>
                                <td>@item.Name</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td><strong>商家通路</strong></td>
                                <td>@item.Store</td>
                            </tr>
                            <tr>
                                <td width="30%"><strong>兌換期限</strong></td>
                                <td>
                                    <span>
                                        @item.AddDate.ToString("yyyy/MM/dd") 至
                                        @item.EndDate.ToString("yyyy/MM/dd")
                                    </span>
                                </td>
                                <td></td>
                            </tr>
                            <tr>
                                <td style="vertical-align:middle"><strong>掃描條碼</strong></td>
                                <td class="barcodeFont"> @item.Barcode</td>
                                @if (!item.IsExpired)
                                {
                                    <td style="vertical-align:middle;text-align:end">
                                        @Html.ActionLink("寄給我", "SendBarcode", new { barcode = item.Barcode }, new { @class = "button default m-0", onclick = "return confirm('確定要將條碼寄送到信箱嗎?');", @style = "text-decoration:none" })

                                    </td>
                                }
                                else
                                {
                                    <td style="vertical-align:middle;text-align:end">
                                        <label class="button disabled primary m-0">已截止</label>
                                    </td>
                                }
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        }

    </div>

</section>

@section Scripts {
    <script src="~/Content/toastr/toastr.min.js"></script>
    <script>
        $(document).ready(function () {
            toastr.options = {
                "debug": false,
                "positionClass": "toast-top-center",
                "text-align": "center",
                "onclick": null,
                "fadeIn": 300,
                "fadeOut": 1000,
                "timeOut": 5000,
                "extendedTimeOut": 1000
            }
            var result = "@TempData["Sent"]";
            console.log(result);
            if (result != "") {
                if (result == "Success") {
                    toastr.success("成功將條碼寄送至信箱");
                }
                else {
                    toastr.error("失敗");
                }
            }
        })

    </script>
    <script>

        var timeOut = null;
        $(document).ready(function () {
            $('#searchText').keyup(function () {
                if (timeOut != null) {
                    clearTimeout(timeOut);
                }
                timeOut = setTimeout(function () {
                    timeOut = null;
                    const text = $('#searchText').val();
                    $('#cartList').html('');
                    $('#searchFilter').val("-1");
                    $.ajax({
                        type: "post",
                        url: "GetCarts?text=" + text,
                        contentType: "html",
                        success: function (result) {
                            $.each(result, function (index, value) {
                                let resultDiv = $("<div></div>")
                                    .addClass("col-12 col-sm-4 col-md-4 d-flex justify-content-center")
                                    .css("margin", "auto");
                                $("<img/>")
                                    .addClass("image")
                                    .css("max-width", "200px").css("width", "100%")
                                    .attr("src", "/Areas/Admin/Content/CartImages/" + value.Image)
                                    .appendTo(resultDiv);

                                let infoDiv = $("<div></div>").addClass("col-12 col-sm-8 col-md-8");

                                let outTbDiv = $("<div></div>").addClass("table-wrapper").appendTo(infoDiv);

                                let tbDiv = $("<table></table>")
                                    .css("margin-bottom", "0px")
                                    .appendTo(outTbDiv)
                                    .append("<thead><tr><th></th><th></th></tr></thead>");

                                let bodyDiv = $("<tbody></tbody>").appendTo(tbDiv)

                                let firstRow = $("<tr></tr>").appendTo(bodyDiv);
                                let nameText = $("<strong></strong>").text("名稱");
                                $("<td></td>").append(nameText).appendTo(firstRow);
                                $("<td></td>").text(value.Name).appendTo(firstRow);
                                $("<td></td>").appendTo(firstRow);

                                let secondRow = $("<tr></tr>").appendTo(bodyDiv);
                                storeText = $("<strong></strong>").text("商家通路");
                                $("<td></td>").append(storeText).appendTo(secondRow);
                                $("<td></td>").text(value.Store).appendTo(secondRow);

                                let thirdRow = $("<tr></tr>").appendTo(bodyDiv);
                                storeText = $("<strong></strong>").text("兌換期限");
                                $("<td></td>").css("width", "30%").append(storeText).appendTo(thirdRow);
                                $("<td></td>").text(value.Duration).appendTo(thirdRow);
                                $("<td></td>").appendTo(thirdRow);


                                let fourthRow = $("<tr></tr>").appendTo(bodyDiv);
                                storeText = $("<strong></strong>").text("掃描條碼");
                                $("<td></td>").css("vertical-align", "middle").append(storeText).appendTo(fourthRow);
                                $("<td></td>")
                                    .addClass("barcodeFont")
                                    .css("font-size", "3em").css("padding", "0px").css("padding-left", "10px")
                                    .text(value.Barcode).appendTo(fourthRow);

                                if (!value.IsExpired) {
                                    let sendBtn = $("<td></td>").css("vertical-align", "middle").css("text-align", "end").appendTo(fourthRow);
                                    $("<a/>").attr("href", "/SendBarcode?barcode=" + value.Barcode)
                                        .addClass("button default m-0")
                                        .css("text-decoration", "none")
                                        .text("寄給我")
                                        .on("click", function () { return confirm("確定要將條碼送到信箱嗎?"); }).appendTo(sendBtn);
                                }
                                else {
                                    let expireLabel = $("<label></label>").addClass("button disabled primary m-0").text("已截止");
                                    $("<td></td>").css("vertical-align", "middle").css("text-align", "end").append(expireLabel).appendTo(fourthRow);;
                                }

                                tbDiv.append("<tfoot><tr><td></td><td></td></tr></tfoot>")

                                resultDiv.appendTo('#cartList');
                                infoDiv.appendTo("#cartList")
                            })
                        }
                    })
                    $('#cartList').html('');
                }, 200)

            })
            $('#searchFilter').change(function () {
                const isAscending = $(this).val();
                $('#searchText').val("");
                $('#cartList').html('');
                $.ajax({
                    type: "post",
                    url: "GetOrderedCarts?isAscending=" + isAscending,
                    contentType: "html",
                    success: function (result) {
                        $.each(result, function (index, value) {
                            let resultDiv = $("<div></div>")
                                .addClass("col-12 col-sm-4 col-md-4 d-flex justify-content-center")
                                .css("margin", "auto");
                            $("<img/>")
                                .addClass("image")
                                .css("max-width", "200px").css("width", "100%")
                                .attr("src", "/Areas/Admin/Content/CartImages/" + value.Image)
                                .appendTo(resultDiv);

                            let infoDiv = $("<div></div>").addClass("col-12 col-sm-8 col-md-8");

                            let outTbDiv = $("<div></div>").addClass("table-wrapper").appendTo(infoDiv);

                            let tbDiv = $("<table></table>")
                                .css("margin-bottom", "0px")
                                .appendTo(outTbDiv)
                                .append("<thead><tr><th></th><th></th></tr></thead>");

                            let bodyDiv = $("<tbody></tbody>").appendTo(tbDiv)

                            let firstRow = $("<tr></tr>").appendTo(bodyDiv);
                            let nameText = $("<strong></strong>").text("名稱");
                            $("<td></td>").append(nameText).appendTo(firstRow);
                            $("<td></td>").text(value.Name).appendTo(firstRow);
                            $("<td></td>").appendTo(firstRow);

                            let secondRow = $("<tr></tr>").appendTo(bodyDiv);
                            storeText = $("<strong></strong>").text("商家通路");
                            $("<td></td>").append(storeText).appendTo(secondRow);
                            $("<td></td>").text(value.Store).appendTo(secondRow);

                            let thirdRow = $("<tr></tr>").appendTo(bodyDiv);
                            storeText = $("<strong></strong>").text("兌換期限");
                            $("<td></td>").css("width", "30%").append(storeText).appendTo(thirdRow);
                            $("<td></td>").text(value.Duration).appendTo(thirdRow);
                            $("<td></td>").appendTo(thirdRow);

                            let fourthRow = $("<tr></tr>").appendTo(bodyDiv);
                            storeText = $("<strong></strong>").text("掃描條碼");
                            $("<td></td>").css("vertical-align", "middle").append(storeText).appendTo(fourthRow);
                            $("<td></td>")
                                .addClass("barcodeFont")
                                .css("font-size", "3em").css("padding", "0px").css("padding-left", "10px")
                                .text(value.Barcode).appendTo(fourthRow);

                            if (!value.IsExpired) {
                                let sendBtn = $("<td></td>").css("vertical-align", "middle").css("text-align", "end").appendTo(fourthRow);
                                $("<a/>").attr("href", "/SendBarcode?barcode=" + value.Barcode)
                                    .addClass("button default m-0")
                                    .css("text-decoration", "none")
                                    .text("寄給我")
                                    .on("click", function () { return confirm("確定要將條碼送到信箱嗎?"); }).appendTo(sendBtn);
                            }
                            else {
                                let expireLabel = $("<label></label>").addClass("button disabled primary m-0").text("已截止");
                                $("<td></td>").css("vertical-align", "middle").css("text-align", "end").append(expireLabel).appendTo(fourthRow);;
                            }

                            tbDiv.append("<tfoot><tr><td></td><td></td></tr></tfoot>")

                            resultDiv.appendTo('#cartList');
                            infoDiv.appendTo("#cartList")
                        })
                    }
                })
            })
        })

    </script>

}