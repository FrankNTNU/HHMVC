
@{
    ViewBag.Title = "Contact";
    Layout = "~/Areas/Admin/Views/Shared/AdminLayout.cshtml";
}

@using DTO
@section Styles {
    <link href="~/Areas/Admin/Content/CSS/adminlte.min.css" rel="stylesheet" />
    <link href="~/Content/css/fontawesome-all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <style>
        .direct-chat-messages .right > .direct-chat-text::after {
            border-left-color: #f56a6a;
            color: #f56a6a;
        }

        .direct-chat-messages :not(.right) > .direct-chat-text::before {
            border-right-color: plum;
            color: plum;
        }
    </style>
    
}
<section class="content-header">
    <h1>線上客服</h1>
    <ol class="breadcrumb float-sm-left">
        <li class="breadcrumb-item"><a>後臺頁面</a></li>
        <li class="breadcrumb-item active"><a>線上客服</a></li>
    </ol>
</section>
<br />
<section class="content">
    <div class="row">
        <div class="col-12 col-md-5">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">在線使用者</h3>

                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped projects">
                        <thead>
                            <tr>
                                <th style="width: 20%">
                                    圖像
                                </th>
                                <th style="width: 30% ">
                                    連線編號
                                </th>
                                <th style="width: 25%">
                                    使用者
                                </th>
                                <th style="width: 25%">
                                    聯絡
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- /.card-body -->
        </div>
        <div class="col-12 col-md-7">
            <div class="col-12 ">
                <!-- DIRECT CHAT WARNING -->
                <div class="card direct-chat">
                    <div class="card-header " style="cursor: default; pointer-events: none; background-color: #007bff ">
                        <h3 id="dialogTitle" class="card-title mb-0" style="color:white;padding:5px">聯絡客服：</h3>
                    </div>
                    <input type="hidden" id="serviceGroupId" />

                    <div id="dialogContainer" class="card-body" style="padding:0px">
                        <!-- Conversations are loaded here -->
                        <div class="direct-chat-messages" id="serviceChatBox" style="margin: 10px; padding:10px">

                        </div>
                        @*<div class="direct-chat-msg right" id="adminbox" style="margin: 10px">

                        </div>*@
                    </div>

                    <div class="card-footer">
                        <div class="input-group">
                            <div class="col-12 col-md-9 col-lg-10 mb-2">
                                <input type="text" name="message" placeholder="輸入訊息..." class="form-control" id="message" autocomplete="off">
                            </div>
                            <div class="col-12 col-md-3 col-lg-2">
                                <span class="input-group-append">
                                    <input type="button" class="btn btn-primary" id="sendmessage" value="傳送" style="width:100%" />

                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</section>

<!--</div>-->
@section scripts {

    <script src="~/Scripts/jquery.signalR-2.4.2.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script src="~/Content/moment-js/moment.min.js"></script>
    <script>

        let notRead = [];
        let connected = [];

        $(function () {

            //========================================================
            //恩旗

            //Receive
            var chat = $.connection.chatHub;
            chat.client.receive = function (connId, userName, message, timeStamp, image, groupId) {

                if ($("#serviceGroupId").val() == groupId) {

                    write(userName, message, $.connection.hub.id == connId, timeStamp, image)

                    let chatBox = document.getElementById("serviceChatBox");
                    chatBox.scrollTop = chatBox.scrollHeight;

                } else if ($.inArray(groupId, notRead) == -1) {

                    notRead.push(groupId);

                }
            }
            //================================================
            //send message

            $.connection.hub.start().done(function () {

                //Auto add to ServiceGroups
                $.ajax({
                    url: "AddToServiceGroups",
                    method: "POST",
                    data: {
                        connId: $.connection.hub.id
                    },
                    success: function (data) {
                        alert(data.Result);
                    }
                });
                //===================================
                $("#sendmessage").click(function () {

                    if ($("#message").val() == "") {
                        alert("請輸入訊息");
                        return;
                    }

                    if ($("#serviceGroupId").val() == "") {
                        alert("尚未連線");
                        return;
                    }

                    $.ajax({
                        url: "SendMessage",
                        type: "POST",
                        data: {
                            connId: $.connection.hub.id,
                            groupId: $("#serviceGroupId").val(),
                            message: $("#message").val()
                        }
                    });
                });
                //==================================================

            });

        });

        function write(userName, message, isSelf, timeStamp, image) {

            if (isSelf) {
                let dialogDiv = $("<div></div>").addClass("direct-chat-msg");

                $("<div></div>").addClass("direct-chat-infos clearfix")
                    .append($("<span></span>").addClass("direct-chat-name float-left").text(userName))
                    .append($("<span></span>").addClass("direct-chat-timestamp float-right").text(timeStamp))
                    .appendTo(dialogDiv);

                $("<img/>").addClass("direct-chat-img")
                    .attr("src", "/Areas/Admin/Content/UserImage/" + image)
                    .appendTo(dialogDiv);

                $("<div></div>").addClass("direct-chat-text")
                    .css("background-color", "plum").css("color", "white").css("border-color", "plum")
                    .html(message)
                    .appendTo(dialogDiv);

                $("#serviceChatBox").append(dialogDiv);

            } else {
                let dialogDiv = $("<div></div>").addClass("direct-chat-msg right");

                $("<div></div>").addClass("direct-chat-infos clearfix")
                    .append($("<span></span>").addClass("direct-chat-name float-right").text(userName))
                    .append($("<span></span>").addClass("direct-chat-timestamp float-left").text(timeStamp))
                    .appendTo(dialogDiv);

                $("<img/>").addClass("direct-chat-img")
                    .attr("src", "/Areas/Admin/Content/UserImage/" + image)
                    .appendTo(dialogDiv);

                $("<div></div>").addClass("direct-chat-text")
                    .css("background-color", "#f56a6a").css("color", "white").css("border-color", "#f56a6a")
                    .html(message)
                    .appendTo(dialogDiv);

                $("#serviceChatBox").append(dialogDiv);
            }

        }

        //Change Customer and loadMessages
        $("tbody").on("click", "a", function () {

            console.log(notRead);

            let groupId = $(this).parent().prev().prev().text();
            $("#serviceGroupId").val(groupId);

            let userName = $(this).parent().prev().text();
            $("#dialogTitle").text(`聯絡客服：${userName}`);

            $(this).text("已連線");
            connected.push(groupId);

            let index = notRead.indexOf(groupId);
            if (index != -1) {
                notRead.splice(index, 1);
            }

            console.log(notRead);
            
            LoadMessages();
        })

        //==========================================================

        setInterval(function () {
            GetOnlineUsers();
        }, 1500);

        function GetOnlineUsers() {
            $.ajax({
                url: "GetServiceGroups",
                type: "POST",
                data: {
                    connId: $.connection.hub.id
                },
                success: function (result) {

                    let docFrag = document.createDocumentFragment();
                    let onlineGroup = [];

                    $.each(result, function (index, value) {

                        let cell1 = $("<td></td>")
                            .append($("<img />").attr("src", "/Areas/Admin/Content/UserImage/" + value.ImagePath)
                                .addClass("direct-chat-img"));

                        let cell2 = $("<td></td>").append(value.GroupID);

                        let cell3 = $("<td></td>").append(value.UserName);

                        let cell4 = $("<td></td>").append($("<a></a>").addClass("btn btn-sm"));

                        if ($.inArray(value.GroupID, notRead) != -1) {
                            $(cell4).children("a").addClass("btn-danger").text("新訊息");
                        } else if ($.inArray(value.GroupID, connected) != -1) {
                            $(cell4).children("a").addClass("btn-primary").text("已連線");
                        } else {
                            $(cell4).children("a").addClass("btn-primary").text("未連線");
                        }

                        $(docFrag).append($("<tr></tr>").append(cell1, cell2, cell3, cell4));

                        onlineGroup.push(value.GroupID);
                    })

                    //Remove offline group from notRead Array
                    $.each(notRead, function (index, value) {
                        if ($.inArray(value, onlineGroup) == -1) {
                            notRead.splice(index, 1);
                        }
                    });

                    //Remove offline group from connected Array
                    $.each(connected, function (index, value) {
                        if ($.inArray(value, onlineGroup) == -1) {
                            connected.splice(index, 1);
                        }
                    });

                    $("tbody").html("");
                    $("tbody").append(docFrag);

                    if (result.length == 0) {
                        $("#dialogTitle").text("聯絡客服：");
                        $("#serviceChatBox").html("");
                    }
                }
            })
        }

        //todo Load Group Messages
        function LoadMessages() {
            if ($("#serviceGroupId").val() != "") {
                $.ajax({
                    url: "GetGroupMsgs",
                    type: "POST",
                    data: {
                        groupId: $("#serviceGroupId").val()
                    },
                    success: function (data) {

                        $("#serviceChatBox").html("");

                        $.each(data, function (i, msg) {
                            write(msg.userName, msg.message, $.connection.hub.id == msg.connId, msg.timeStamp, msg.image);
                        });

                        let chatBox = document.getElementById("serviceChatBox");
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                });
            }
        }
    </script>
}

